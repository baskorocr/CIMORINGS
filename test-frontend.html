<!DOCTYPE html>
<html>
<head>
    <title>CSMS Socket Test</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>
<body>
    <h1>CSMS Socket.IO Test</h1>
    <div id="status">Connecting...</div>
    <div id="messages"></div>

    <script>
        const socket = io('http://192.168.0.109:3000', {
            autoConnect: true,
            reconnection: true,
            reconnectionDelay: 1000,
            reconnectionAttempts: 5,
            transports: ['websocket', 'polling']
        });

        const statusDiv = document.getElementById('status');
        const messagesDiv = document.getElementById('messages');

        function addMessage(message) {
            const div = document.createElement('div');
            div.innerHTML = new Date().toLocaleTimeString() + ': ' + message;
            messagesDiv.appendChild(div);
        }

        socket.on('connect', () => {
            statusDiv.innerHTML = '‚úÖ Connected (ID: ' + socket.id + ')';
            statusDiv.style.color = 'green';
            addMessage('Socket connected successfully');
        });

        socket.on('disconnect', () => {
            statusDiv.innerHTML = '‚ùå Disconnected';
            statusDiv.style.color = 'red';
            addMessage('Socket disconnected');
        });

        socket.on('connect_error', (error) => {
            statusDiv.innerHTML = '‚ùå Connection Error: ' + error.message;
            statusDiv.style.color = 'red';
            addMessage('Connection error: ' + error.message);
        });

        socket.on('transaction_started', (data) => {
            addMessage('üîã Transaction started: ' + JSON.stringify(data));
        });

        socket.on('transaction_stopped', (data) => {
            addMessage('üõë Transaction stopped: ' + JSON.stringify(data));
        });

        socket.on('meter_values', (data) => {
            addMessage('‚ö° Meter values: ' + JSON.stringify(data));
        });

        // Test API call
        async function testAPI() {
            try {
                const response = await fetch('http://192.168.0.109:3000/api/transactions/active', {
                    headers: {
                        'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MSwidXNlcm5hbWUiOiJhZG1pbiIsInJvbGUiOiJhZG1pbiIsImlhdCI6MTc2NjI1NzkxNywiZXhwIjoxNzY2MzQ0MzE3fQ.Id25LtxbKZG6YNTgjNRr8WIcwGc9mj4VrFtKV0cwdL0'
                    }
                });
                const data = await response.json();
                addMessage('üìä API Test - Active transactions: ' + data.length);
            } catch (error) {
                addMessage('‚ùå API Test failed: ' + error.message);
            }
        }

        // Test API after 2 seconds
        setTimeout(testAPI, 2000);
    </script>
</body>
</html>